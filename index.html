<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<meta charset="utf-8">
	</head>
	<title>SeatingPlanGenerator</title>
	<body>
		<form name='form' id='seatingplan'>
			<table border="1" id="seatingTable" align="center">
				<tr>
					<td colspan="2"><center><h1>座位產生器</h1></center></td>
				</tr>
				<tr>
					<td>請輸入座位數量,有幾排?(行)：<input type='text' name='column' id='column' /></td>
					<td>每排有幾個?(列)：<input type='text' name='row' id='row' /></td>
				</tr>
				<tr>
					<td>起始座號：<input type='text' name='startNum' id='startNum' /></td>
					<td>結束座號：<input type='text' name='endNum' id='endNum' /></td>
				</tr>
				<tr>
					<td colspan="2">(非必填)座號缺號：(可填多個座號,以逗號隔開)<input type='text' name='emptyNums' id='emptyNums' /></td>
				</tr>
				<tr>
					<td colspan="2">(非必填)預選座位1：(第幾排,第幾個,座號.  空位請輸入座號0. Ex: 2,1,10)<input type='text' name='reservedNum' id='reservedNum' /></td>
				</tr>
				<tr>
					<td colspan="2"><input type='button' name='add' value='增加預選座位' onclick='addReservedNum();' /><input type='button' name='add' value='減少預選座位' onclick='removeReservedNum();' /></td>
				</tr>
				<tr>
					<td colspan="2"><input type='button' name='submit' value='產生座位表' onclick='processFormData();' /></td>
				</tr>
			</table>
		</form>


  <!--
  <textarea id="text-val" rows="4">This is initial template</textarea><br/>
	<input type="button" id="dwn-btn" value="Download dinamically generated text file"/>
	-->
				
<script>

function addReservedNum() {
	var row = document.getElementById('row').value;
  var column = document.getElementById('column').value;
  var start = document.getElementById('startNum').value;
  var end = document.getElementById('endNum').value;
	if(!isValidData1(row,column,start,end)){
  	alert('座位數量或起始/結束座號輸入錯誤!! 輸入正確前無法新增預選座位!!');
  	return;
  }
  
	var rowNum = document.getElementById("seatingTable").rows.length;
	if(rowNum > row*column+5){
		alert("無法再新增預選座位!!");
		return;
	}
	
	var tr = document.getElementById("seatingTable").insertRow(rowNum-2);
 //建立新的td 而Tr.cells.length就是這個tr目前的td數
	var td = tr.insertCell(tr.cells.length);
	var content = "(非必填)預選座位" + (rowNum-5) + "：(第幾排,第幾個,座號.  空位請輸入座號0. Ex: 2,1,10)<input type='text' name='reservedNum' id='reservedNum' />";
 	td.innerHTML = content;
 	td.colSpan = "2";
}

function removeReservedNum() {
	var rowNum = document.getElementById("seatingTable").rows.length;
	if(rowNum > 7) {
		document.getElementById("seatingTable").deleteRow(rowNum-3);
	}else
		alert("若無需輸入預選座位,保留空白即可");
}

function processFormData() {
  var row = document.getElementById('row').value;
  var column = document.getElementById('column').value;
  var start = document.getElementById('startNum').value;
  var end = document.getElementById('endNum').value;
  var emptyRaw = document.getElementById('emptyNums').value;
	var reservedRaw = document.getElementsByName('reservedNum');
	
  if(!isValidData1(row,column,start,end)){
  	alert('座位數量或起始/結束座號輸入錯誤!! 請重新輸入');
  	return;
  }
  
	var numList = handleEmptyNums(start, end, emptyRaw.split(','));
  //for debug
  alert(numList);
  
  var reservedNums = [];
  for(var i=0; i < reservedRaw.length ; i++){
  	var tmp = reservedRaw[i].value.split(',');
  	if(tmp == '')
  		continue;
  	
  	if(!isValidData2(tmp, column, row, numList)){
  		alert('預選座位資料輸入錯誤!! 請重新輸入');
  		return;
  	}else
  		reservedNums.push(tmp);
	}
	
	//for debug
	for(var i=0; i < reservedNums.length ; i++){
		alert(reservedNums[i]);
	}

  //initial 2d-array for output
}

function isValidData1(row, column, start, end){
	return !(isNaN(row) || isNaN(column) || isNaN(start) || isNaN(end) || row <= 0 || column <= 0 || start <= 0 || end <= start);  	
}

function isValidData2(nums, column, row, numList){
	if(nums.length != 3)
		return false;
		
	for(var i=0; i < nums.length ; i++){
		if(nums[i] == '' || isNaN(nums[i]))
			return false;
	}
	
	return !(nums[0] <= 0 || nums[1] <=0 || nums[0] > column || nums[1] > row || nums[2] < 0 || (nums[2] != 0 && numList.indexOf(parseInt(nums[2])) == -1))
}

function handleEmptyNums(start, end, emptyRaw){
	var numList = new Array(end-start+1);
	for(var i = start ; i <= end ; i++){
		numList[i-1] = i;
	}
	
	for(var j = 0; j < emptyRaw.length ; j++){
		if(!isNaN(emptyRaw[j]) && emptyRaw[j] !== ''){
			var index = numList.indexOf(parseInt(emptyRaw[j],10));
			if(index > -1)
				numList.splice(index, 1);
		}
	}
	return numList;
}

function download(filename, text) {
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);
  element.style.display = 'none';
  document.body.appendChild(element);
  element.click();
  document.body.removeChild(element);
}

// Start file download.
//download("hello.txt","This is the content of my file :)");


// Start file download.
document.getElementById("dwn-btn").addEventListener("click", function(){
    // Generate download of hello.txt file with some content
    var text = document.getElementById("text-val").value;
    var filename = "hello.txt";
    download(filename, text);
}, false);
            
</script>

	</body>
</html>
